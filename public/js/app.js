angular.module("cirrusSounds",["app.controllers","app.directives","app.filters","app.services","ui.router","satellizer","ngAnimate"]).config(["$stateProvider","$urlRouterProvider",function(t,e){t.state("home",{url:"/",templateUrl:"home.html"}).state("trending",{url:"/popular",templateUrl:"trending.html",controller:"NavCtrl",onEnter:["$state","$auth",function(t,e){e.isAuthenticated()||t.go("home")}]}).state("trending.today",{url:"/today",templateUrl:"trending-list.html",controller:"TrendingCtrl",resolve:{timeframe:function(){return{time:"day"}}}}).state("trending.week",{url:"/this-week",templateUrl:"trending-list.html",controller:"TrendingCtrl",resolve:{timeframe:function(){return{time:"week"}}}}).state("trending.month",{url:"/this-month",templateUrl:"trending-list.html",controller:"TrendingCtrl",resolve:{timeframe:function(){return{time:"month"}}}}).state("trending.allTime",{url:"/all-time",templateUrl:"trending-list.html",controller:"TrendingCtrl",resolve:{timeframe:function(){return{time:"allTime"}}}}),e.otherwise("/")}]).config(["$authProvider","clientId",function(t,e){t.oauth2({name:"soundcloud",url:"/auth/soundcloud",clientId:e,redirectUri:window.location.origin,authorizationEndpoint:"https://soundcloud.com/connect",optionalUrlParams:["display"],display:"popup"})}]).run(["$rootScope",function(t){t.messages={},t.$on("$stateChangeSuccess",function(){t.messages={}})}]),angular.module("app.controllers",[]).controller("MainCtrl",["$rootScope","$scope","$http","$auth","Account","$state",function(t,e,n,r,o,a){e.authenticating=!1,e.clearMessages=function(){t.messages={}},e.login=function(){return e.authenticating=!0,r.authenticate("soundcloud").then(function(){e.getProfile().then(function(){a.go("trending"),e.authenticating=!1})}).catch(function(n){e.authenticating=!1,n&&(t.messages.error=n.data.errors)})},e.logout=function(){return r.logout().then(function(){e.user=null})},e.isAuthenticated=function(){return r.isAuthenticated()},e.getProfile=function(){return o.get().then(function(t){return e.user=t.data,e.user}).catch(function(e){e&&(t.messages.error=e.data.errors)})}}]).controller("NavCtrl",["$rootScope","$scope","$state","Soundcloud",function(t,e,n){n.go("trending.week"),e.activeTab=function(t){return t===n.current.name},e.$on("data:notFound",function(){t.messages.noDataFound=!0}),e.$on("data:follow",function(){t.messages.follow=!0}),e.$on("data:error",function(e,n){console.log(n),t.messages.error=n.data.errors})}]).controller("TrendingCtrl",["$scope","$q","Soundcloud","musicCache","timeframe","$state",function(t,e,n,r,o){t.showLoading=!1,r.cached?e.when(n.filterByTime(r.get(),o.time)).then(function(e){t.showLoading=!1,t.songs=e,e.length?e.length<10&&t.$emit("data:follow"):t.$emit("data:notFound")}).catch(function(e){t.showLoading=!1,e&&t.$emit("data:error",e)}):(t.showLoading=!0,t.getProfile().then(function(a){n.parseUser(a.uid).then(function(a){t.showLoading=!1,r.set(a),e.when(n.filterByTime(a,o.time)).then(function(e){t.songs=e,e.length?e.length<10&&t.$emit("data:follow"):t.$emit("data:notFound")}).catch(function(e){e&&t.$emit("data:error",e)})}).catch(function(e){e&&t.$emit("data:error",e)})}))}]),function(){angular.module("app.directives",[]).directive("musicPlayer",["$http","soundcloudUrl","clientId",function(t,e,n){return{restrict:"A",templateUrl:"music-player.html",scope:{url:"@",title:"@",username:"@",artistUrl:"@"},link:function(t,r,o){var a,i,u;return a=document.createElement("audio"),i=0,u=""+e+"tracks/"+o.musicPlayer+"/stream?client_id="+n,t.playing=!1,t.currentTime=0,t.duration=0,t.loadingSong=!1,t.play=function(){return t.loadingSong=!0,a.src=u,a.play(),a.addEventListener("canplay",function(){return t.loadingSong=!1,a.currentTime||(a.currentTime=i),t.playing=!0})},t.pause=function(){return a.pause(),t.loadingSong=!1,t.playing=!1},t.seek=function(t){var e,n,r,o;return(n=t.offsetX||t.layerX-t.target.offsetLeft)?(r=n/t.target.offsetWidth,e=a.duration,o=e*r,a.currentTime=parseInt(o,10)):void 0},a.addEventListener("pause",function(){return i=a.currentTime},!1),a.addEventListener("timeupdate",function(){return t.$apply(function(){return t.currentTime=a.currentTime,t.duration=a.duration})},!1),a.addEventListener("ended",function(){return i=0,t.$apply(function(){return t.playing=!1})},!1)}}}])}.call(this),angular.module("app.filters",[]),angular.module("app.services",[]).constant("clientId","863060121a2ffb5d258e7a793da0546b").constant("soundcloudUrl","//api.soundcloud.com/").factory("Soundcloud",["$http","$q","clientId","soundcloudUrl",function(t,e,n,r){var o={client_id:n},a=function(t){return i(t).then(function(t){return u(t)}).then(function(t){return l(_.flatten(t))})},i=function(e){return t.get(r+"users/"+e+"/followings.json",{params:o}).then(function(t){return t.data})},u=function(t){return e.all(_.map(t,function(t){return c(t.id)}))},c=function(n){return e.all([t.get(r+"users/"+n+"/favorites.json",{params:o}),t.get(r+"users/"+n+"/tracks.json",{params:o})])},l=function(t){return _(t).map(function(t){return t.data?t.data:void 0}).flatten().reject(function(t){return!t.playback_count}).uniq("id")},s=function(t,e){var n=new Date;return e="day"===e?n.setDate(n.getDate()-1):"week"===e?n.setDate(n.getDate()-7):"month"===e?n.setMonth(n.getMonth()-1):null,t.reject(function(t){return e?Date.parse(t.created_at)<e:void 0}).sortBy("playback_count").reverse().first(10).value()};return{parseUser:a,filterByTime:s}}]).factory("Account",["$http",function(t){return{get:function(){return t.get("/api/me")}}}]).factory("musicCache",function(){var t=[];return{get:function(){return t},set:function(e){t=e,this.cached=!0},cached:!1}});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyIsImNvbnRyb2xsZXJzLmpzIiwiZGlyZWN0aXZlcy5jb2ZmZWUiLCJmaWx0ZXJzLmpzIiwic2VydmljZXMuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsUUFBQSxPQUFBLGdCQUFBLGtCQUFBLGlCQUFBLGNBQUEsZUFBQSxZQUFBLGFBQUEsY0FFQSxRQUFBLGlCQUFBLHFCQUFBLFNBQUEsRUFBQSxHQUNBLEVBQ0EsTUFBQSxRQUNBLElBQUEsSUFDQSxZQUFBLGNBRUEsTUFBQSxZQUNBLElBQUEsV0FDQSxZQUFBLGdCQUNBLFdBQUEsVUFDQSxTQUFBLFNBQUEsUUFBQSxTQUFBLEVBQUEsR0FDQSxFQUFBLG1CQUFBLEVBQUEsR0FBQSxZQUdBLE1BQUEsa0JBQ0EsSUFBQSxTQUNBLFlBQUEscUJBQ0EsV0FBQSxlQUNBLFNBQ0EsVUFBQSxXQUNBLE9BQUEsS0FBQSxXQUlBLE1BQUEsaUJBQ0EsSUFBQSxhQUNBLFlBQUEscUJBQ0EsV0FBQSxlQUNBLFNBQ0EsVUFBQSxXQUNBLE9BQUEsS0FBQSxZQUlBLE1BQUEsa0JBQ0EsSUFBQSxjQUNBLFlBQUEscUJBQ0EsV0FBQSxlQUNBLFNBQ0EsVUFBQSxXQUNBLE9BQUEsS0FBQSxhQUlBLE1BQUEsb0JBQ0EsSUFBQSxZQUNBLFlBQUEscUJBQ0EsV0FBQSxlQUNBLFNBQ0EsVUFBQSxXQUNBLE9BQUEsS0FBQSxlQUtBLEVBQUEsVUFBQSxRQUdBLFFBQUEsZ0JBQUEsV0FBQSxTQUFBLEVBQUEsR0FFQSxFQUFBLFFBQ0EsS0FBQSxhQUNBLElBQUEsbUJBQ0EsU0FBQSxFQUNBLFlBQUEsT0FBQSxTQUFBLE9BQ0Esc0JBQUEsaUNBQ0EsbUJBQUEsV0FDQSxRQUFBLGFBS0EsS0FBQSxhQUFBLFNBQUEsR0FDQSxFQUFBLFlBRUEsRUFBQSxJQUFBLHNCQUFBLFdBQ0EsRUFBQSxpQkM5RUEsUUFBQSxPQUFBLHNCQUNBLFdBQUEsWUFBQSxhQUFBLFNBQUEsUUFBQSxRQUFBLFVBQUEsU0FBQSxTQUFBLEVBQUEsRUFBQSxFQUFBLEVBQUEsRUFBQSxHQUVBLEVBQUEsZ0JBQUEsRUFFQSxFQUFBLGNBQUEsV0FDQSxFQUFBLGFBR0EsRUFBQSxNQUFBLFdBRUEsTUFEQSxHQUFBLGdCQUFBLEVBQ0EsRUFBQSxhQUFBLGNBQ0EsS0FBQSxXQUNBLEVBQUEsYUFDQSxLQUFBLFdBQ0EsRUFBQSxHQUFBLFlBQ0EsRUFBQSxnQkFBQSxNQUdBLE1BQUEsU0FBQSxHQUNBLEVBQUEsZ0JBQUEsRUFDQSxJQUFBLEVBQUEsU0FBQSxNQUFBLEVBQUEsS0FBQSxXQUlBLEVBQUEsT0FBQSxXQUNBLE1BQUEsR0FBQSxTQUNBLEtBQUEsV0FDQSxFQUFBLEtBQUEsUUFJQSxFQUFBLGdCQUFBLFdBQ0EsTUFBQSxHQUFBLG1CQUdBLEVBQUEsV0FBQSxXQUNBLE1BQUEsR0FBQSxNQUNBLEtBQUEsU0FBQSxHQUVBLE1BREEsR0FBQSxLQUFBLEVBQUEsS0FDQSxFQUFBLE9BRUEsTUFBQSxTQUFBLEdBQ0EsSUFBQSxFQUFBLFNBQUEsTUFBQSxFQUFBLEtBQUEsY0FNQSxXQUFBLFdBQUEsYUFBQSxTQUFBLFNBQUEsYUFBQSxTQUFBLEVBQUEsRUFBQSxHQUVBLEVBQUEsR0FBQSxpQkFFQSxFQUFBLFVBQUEsU0FBQSxHQUNBLE1BQUEsS0FBQSxFQUFBLFFBQUEsTUFHQSxFQUFBLElBQUEsZ0JBQUEsV0FDQSxFQUFBLFNBQUEsYUFBQSxJQUdBLEVBQUEsSUFBQSxjQUFBLFdBQ0EsRUFBQSxTQUFBLFFBQUEsSUFHQSxFQUFBLElBQUEsYUFBQSxTQUFBLEVBQUEsR0FDQSxRQUFBLElBQUEsR0FDQSxFQUFBLFNBQUEsTUFBQSxFQUFBLEtBQUEsWUFJQSxXQUFBLGdCQUNBLFNBQUEsS0FBQSxhQUFBLGFBQUEsWUFBQSxTQUNBLFNBQUEsRUFBQSxFQUFBLEVBQUEsRUFBQSxHQUVBLEVBQUEsYUFBQSxFQUVBLEVBQUEsT0FDQSxFQUFBLEtBQUEsRUFBQSxhQUFBLEVBQUEsTUFBQSxFQUFBLE9BQ0EsS0FBQSxTQUFBLEdBQ0EsRUFBQSxhQUFBLEVBQ0EsRUFBQSxNQUFBLEVBQ0EsRUFBQSxPQUVBLEVBQUEsT0FBQSxJQUNBLEVBQUEsTUFBQSxlQUZBLEVBQUEsTUFBQSxtQkFLQSxNQUFBLFNBQUEsR0FDQSxFQUFBLGFBQUEsRUFDQSxHQUFBLEVBQUEsTUFBQSxhQUFBLE1BR0EsRUFBQSxhQUFBLEVBQ0EsRUFBQSxhQUFBLEtBQUEsU0FBQSxHQUVBLEVBQUEsVUFBQSxFQUFBLEtBQ0EsS0FBQSxTQUFBLEdBQ0EsRUFBQSxhQUFBLEVBQ0EsRUFBQSxJQUFBLEdBRUEsRUFBQSxLQUFBLEVBQUEsYUFBQSxFQUFBLEVBQUEsT0FDQSxLQUFBLFNBQUEsR0FDQSxFQUFBLE1BQUEsRUFDQSxFQUFBLE9BRUEsRUFBQSxPQUFBLElBQ0EsRUFBQSxNQUFBLGVBRkEsRUFBQSxNQUFBLG1CQUtBLE1BQUEsU0FBQSxHQUNBLEdBQUEsRUFBQSxNQUFBLGFBQUEsT0FHQSxNQUFBLFNBQUEsR0FDQSxHQUFBLEVBQUEsTUFBQSxhQUFBLFdDbkhBLFdBQUEsUUFBUSxPQUFPLHFCQUVkLFVBQVUsZUFBZ0IsUUFBUyxnQkFBaUIsV0FBWSxTQUFDLEVBQU8sRUFBZSxVQUN0RixTQUFVLElBQ1YsWUFBYSxvQkFDYixPQUNFLElBQUssSUFDTCxNQUFPLElBQ1AsU0FBVSxJQUNWLFVBQVcsS0FDYixLQUFNLFNBQUMsRUFBTyxFQUFNLEdBRWxCLEdBQUEsR0FBQSxFQUFBLFFBQUEsR0FBUSxTQUFTLGNBQWMsU0FDL0IsRUFBYyxFQUNkLEVBQU0sR0FBRyxFQUFjLFVBQVMsRUFBTSxZQUFZLHFCQUFvQixFQUV0RSxFQUFNLFNBQVUsRUFDaEIsRUFBTSxZQUFjLEVBQ3BCLEVBQU0sU0FBVyxFQUNqQixFQUFNLGFBQWMsRUFFcEIsRUFBTSxLQUFPLGlCQUNYLEdBQU0sYUFBYyxFQUNwQixFQUFNLElBQU0sRUFDWixFQUFNLE9BQ04sRUFBTSxpQkFBaUIsVUFBVyxpQkFDaEMsR0FBTSxhQUFjLEVBQ3BCLEVBQU0sY0FBTixFQUFNLFlBQWdCLEdBQ3RCLEVBQU0sU0FBVSxLQUVwQixFQUFNLE1BQVEsaUJBQ1osR0FBTSxRQUNOLEVBQU0sYUFBYyxFQUNwQixFQUFNLFNBQVUsR0FFbEIsRUFBTSxLQUFPLFNBQUMsR0FFWixHQUFBLEdBQUEsRUFBQSxFQUFBLENBQUEsUUFBRyxFQUFTLEVBQUUsU0FBVyxFQUFFLE9BQVMsRUFBRSxPQUFPLGFBQzNDLEVBQVUsRUFBUyxFQUFFLE9BQU8sWUFDNUIsRUFBVyxFQUFNLFNBQ2pCLEVBQVMsRUFBVyxFQUNwQixFQUFNLFlBQWMsU0FBUyxFQUFRLEtBSnZDLFFBTUYsRUFBTSxpQkFBaUIsUUFBUyxpQkFDOUIsR0FBYyxFQUFNLGNBQ3BCLEdBRUYsRUFBTSxpQkFBaUIsYUFBYyxpQkFDbkMsR0FBTSxPQUFPLGlCQUNYLEdBQU0sWUFBYyxFQUFNLFlBQzFCLEVBQU0sU0FBVyxFQUFNLGFBQ3pCLEdBRUYsRUFBTSxpQkFBaUIsUUFBUyxpQkFDOUIsR0FBYyxFQUNkLEVBQU0sT0FBTyxpQkFDWCxHQUFNLFNBQVUsTUFDbEIsb0JDekROLFFBQUEsT0FBQSxrQkNBQSxRQUFBLE9BQUEsbUJBRUEsU0FBQSxXQUFBLG9DQUNBLFNBQUEsZ0JBQUEseUJBRUEsUUFBQSxjQUFBLFFBQUEsS0FBQSxXQUFBLGdCQUFBLFNBQUEsRUFBQSxFQUFBLEVBQUEsR0FFQSxHQUFBLElBQ0EsVUFBQSxHQUdBLEVBQUEsU0FBQSxHQUNBLE1BQUEsR0FBQSxHQUNBLEtBQUEsU0FBQSxHQUFBLE1BQUEsR0FBQSxLQUNBLEtBQUEsU0FBQSxHQUFBLE1BQUEsR0FBQSxFQUFBLFFBQUEsT0FJQSxFQUFBLFNBQUEsR0FDQSxNQUFBLEdBQUEsSUFBQSxFQUFBLFNBQUEsRUFBQSxvQkFDQSxPQUFBLElBQ0EsS0FBQSxTQUFBLEdBQUEsTUFBQSxHQUFBLFFBR0EsRUFBQSxTQUFBLEdBQ0EsTUFBQSxHQUFBLElBQUEsRUFBQSxJQUFBLEVBQUEsU0FBQSxHQUNBLE1BQUEsR0FBQSxFQUFBLFFBSUEsRUFBQSxTQUFBLEdBQ0EsTUFBQSxHQUFBLEtBQ0EsRUFBQSxJQUFBLEVBQUEsU0FBQSxFQUFBLG1CQUFBLE9BQUEsSUFDQSxFQUFBLElBQUEsRUFBQSxTQUFBLEVBQUEsZ0JBQUEsT0FBQSxPQUlBLEVBQUEsU0FBQSxHQUdBLE1BQUEsR0FBQSxHQUNBLElBQUEsU0FBQSxHQUFBLE1BQUEsR0FBQSxLQUFBLEVBQUEsS0FBQSxTQUNBLFVBQ0EsT0FBQSxTQUFBLEdBQUEsT0FBQSxFQUFBLGlCQUNBLEtBQUEsT0FJQSxFQUFBLFNBQUEsRUFBQSxHQUNBLEdBQUEsR0FBQSxHQUFBLEtBWUEsT0FUQSxHQURBLFFBQUEsRUFDQSxFQUFBLFFBQUEsRUFBQSxVQUFBLEdBQ0EsU0FBQSxFQUNBLEVBQUEsUUFBQSxFQUFBLFVBQUEsR0FDQSxVQUFBLEVBQ0EsRUFBQSxTQUFBLEVBQUEsV0FBQSxHQUVBLEtBR0EsRUFDQSxPQUFBLFNBQUEsR0FDQSxNQUFBLEdBQUEsS0FBQSxNQUFBLEVBQUEsWUFBQSxFQUNBLFNBRUEsT0FBQSxrQkFDQSxVQUNBLE1BQUEsSUFDQSxRQUdBLFFBQ0EsVUFBQSxFQUNBLGFBQUEsTUFJQSxRQUFBLFdBQUEsUUFBQSxTQUFBLEdBQ0EsT0FDQSxJQUFBLFdBQ0EsTUFBQSxHQUFBLElBQUEsZ0JBS0EsUUFBQSxhQUFBLFdBQ0EsR0FBQSxLQUNBLFFBQ0EsSUFBQSxXQUFBLE1BQUEsSUFDQSxJQUFBLFNBQUEsR0FDQSxFQUFBLEVBQ0EsS0FBQSxRQUFBLEdBRUEsUUFBQSIsImZpbGUiOiJhcHAuanMiLCJzb3VyY2VzQ29udGVudCI6WyJhbmd1bGFyLm1vZHVsZSgnY2lycnVzU291bmRzJywgWydhcHAuY29udHJvbGxlcnMnLCAnYXBwLmRpcmVjdGl2ZXMnLCAnYXBwLmZpbHRlcnMnLCAnYXBwLnNlcnZpY2VzJywgJ3VpLnJvdXRlcicsICdzYXRlbGxpemVyJywgJ25nQW5pbWF0ZSddKVxuXG4uY29uZmlnKFsnJHN0YXRlUHJvdmlkZXInLCAnJHVybFJvdXRlclByb3ZpZGVyJywgZnVuY3Rpb24oJHN0YXRlUHJvdmlkZXIsICR1cmxSb3V0ZXJQcm92aWRlcikge1xuICAkc3RhdGVQcm92aWRlclxuICAgIC5zdGF0ZSgnaG9tZScsIHtcbiAgICAgIHVybDogJy8nLFxuICAgICAgdGVtcGxhdGVVcmw6ICdob21lLmh0bWwnXG4gICAgfSlcbiAgICAuc3RhdGUoJ3RyZW5kaW5nJywge1xuICAgICAgdXJsOiAnL3BvcHVsYXInLFxuICAgICAgdGVtcGxhdGVVcmw6ICd0cmVuZGluZy5odG1sJyxcbiAgICAgIGNvbnRyb2xsZXI6ICdOYXZDdHJsJyxcbiAgICAgIG9uRW50ZXI6IFsnJHN0YXRlJywgJyRhdXRoJywgZnVuY3Rpb24oJHN0YXRlLCAkYXV0aCkge1xuICAgICAgICBpZiAoISRhdXRoLmlzQXV0aGVudGljYXRlZCgpKSB7ICRzdGF0ZS5nbygnaG9tZScpOyB9XG4gICAgICB9XVxuICAgIH0pXG4gICAgLnN0YXRlKCd0cmVuZGluZy50b2RheScsIHtcbiAgICAgIHVybDogJy90b2RheScsXG4gICAgICB0ZW1wbGF0ZVVybDogJ3RyZW5kaW5nLWxpc3QuaHRtbCcsXG4gICAgICBjb250cm9sbGVyOiAnVHJlbmRpbmdDdHJsJyxcbiAgICAgIHJlc29sdmU6IHtcbiAgICAgICAgJ3RpbWVmcmFtZSc6IGZ1bmN0aW9uKCkge1xuICAgICAgICAgIHJldHVybiB7dGltZTogJ2RheSd9O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSlcbiAgICAuc3RhdGUoJ3RyZW5kaW5nLndlZWsnLCB7XG4gICAgICB1cmw6ICcvdGhpcy13ZWVrJyxcbiAgICAgIHRlbXBsYXRlVXJsOiAndHJlbmRpbmctbGlzdC5odG1sJyxcbiAgICAgIGNvbnRyb2xsZXI6ICdUcmVuZGluZ0N0cmwnLFxuICAgICAgcmVzb2x2ZToge1xuICAgICAgICAndGltZWZyYW1lJzogZnVuY3Rpb24oKSB7XG4gICAgICAgICAgcmV0dXJuIHt0aW1lOiAnd2Vlayd9O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSlcbiAgICAuc3RhdGUoJ3RyZW5kaW5nLm1vbnRoJywge1xuICAgICAgdXJsOiAnL3RoaXMtbW9udGgnLFxuICAgICAgdGVtcGxhdGVVcmw6ICd0cmVuZGluZy1saXN0Lmh0bWwnLFxuICAgICAgY29udHJvbGxlcjogJ1RyZW5kaW5nQ3RybCcsXG4gICAgICByZXNvbHZlOiB7XG4gICAgICAgICd0aW1lZnJhbWUnOiBmdW5jdGlvbigpIHtcbiAgICAgICAgICByZXR1cm4ge3RpbWU6ICdtb250aCd9O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSlcbiAgICAuc3RhdGUoJ3RyZW5kaW5nLmFsbFRpbWUnLCB7XG4gICAgICB1cmw6ICcvYWxsLXRpbWUnLFxuICAgICAgdGVtcGxhdGVVcmw6ICd0cmVuZGluZy1saXN0Lmh0bWwnLFxuICAgICAgY29udHJvbGxlcjogJ1RyZW5kaW5nQ3RybCcsXG4gICAgICByZXNvbHZlOiB7XG4gICAgICAgICd0aW1lZnJhbWUnOiBmdW5jdGlvbigpIHtcbiAgICAgICAgICByZXR1cm4ge3RpbWU6ICdhbGxUaW1lJ307XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcblxuICAkdXJsUm91dGVyUHJvdmlkZXIub3RoZXJ3aXNlKCcvJyk7XG59XSlcblxuLmNvbmZpZyhbJyRhdXRoUHJvdmlkZXInLCAnY2xpZW50SWQnLCBmdW5jdGlvbigkYXV0aFByb3ZpZGVyLCBjbGllbnRJZCkge1xuXG4gICRhdXRoUHJvdmlkZXIub2F1dGgyKHtcbiAgICBuYW1lOiAnc291bmRjbG91ZCcsXG4gICAgdXJsOiAnL2F1dGgvc291bmRjbG91ZCcsXG4gICAgY2xpZW50SWQ6IGNsaWVudElkLFxuICAgIHJlZGlyZWN0VXJpOiB3aW5kb3cubG9jYXRpb24ub3JpZ2luLFxuICAgIGF1dGhvcml6YXRpb25FbmRwb2ludDogJ2h0dHBzOi8vc291bmRjbG91ZC5jb20vY29ubmVjdCcsXG4gICAgb3B0aW9uYWxVcmxQYXJhbXM6IFsnZGlzcGxheSddLFxuICAgIGRpc3BsYXk6ICdwb3B1cCdcbiAgfSk7XG5cbn1dKVxuXG4ucnVuKFsnJHJvb3RTY29wZScsIGZ1bmN0aW9uKCRyb290U2NvcGUpIHtcbiAgJHJvb3RTY29wZS5tZXNzYWdlcyA9IHt9O1xuXG4gICRyb290U2NvcGUuJG9uKCckc3RhdGVDaGFuZ2VTdWNjZXNzJywgZnVuY3Rpb24oZXZ0KSB7XG4gICAgJHJvb3RTY29wZS5tZXNzYWdlcyA9IHt9O1xuICB9KTtcbn1dKTtcbiIsImFuZ3VsYXIubW9kdWxlKCdhcHAuY29udHJvbGxlcnMnLCBbXSlcbi5jb250cm9sbGVyKCdNYWluQ3RybCcsIFsnJHJvb3RTY29wZScsICckc2NvcGUnLCAnJGh0dHAnLCAnJGF1dGgnLCAnQWNjb3VudCcsICckc3RhdGUnLCBmdW5jdGlvbigkcm9vdFNjb3BlLCAkc2NvcGUsICRodHRwLCAkYXV0aCwgQWNjb3VudCwgJHN0YXRlKSB7XG5cbiAgJHNjb3BlLmF1dGhlbnRpY2F0aW5nID0gZmFsc2U7XG5cbiAgJHNjb3BlLmNsZWFyTWVzc2FnZXMgPSBmdW5jdGlvbigpIHtcbiAgICAkcm9vdFNjb3BlLm1lc3NhZ2VzID0ge307XG4gIH07XG5cbiAgJHNjb3BlLmxvZ2luID0gZnVuY3Rpb24oKSB7XG4gICAgJHNjb3BlLmF1dGhlbnRpY2F0aW5nID0gdHJ1ZTtcbiAgICByZXR1cm4gJGF1dGguYXV0aGVudGljYXRlKCdzb3VuZGNsb3VkJylcbiAgICAgIC50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKSB7XG4gICAgICAgICRzY29wZS5nZXRQcm9maWxlKClcbiAgICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgICAgJHN0YXRlLmdvKCd0cmVuZGluZycpO1xuICAgICAgICAgICRzY29wZS5hdXRoZW50aWNhdGluZyA9IGZhbHNlO1xuICAgICAgICB9KTtcbiAgICAgIH0pXG4gICAgICAuY2F0Y2goZnVuY3Rpb24oZXJyb3IpIHtcbiAgICAgICAgJHNjb3BlLmF1dGhlbnRpY2F0aW5nID0gZmFsc2U7XG4gICAgICAgIGlmIChlcnJvcikgJHJvb3RTY29wZS5tZXNzYWdlcy5lcnJvciA9IGVycm9yLmRhdGEuZXJyb3JzO1xuICAgICAgfSk7XG4gIH07XG5cbiAgJHNjb3BlLmxvZ291dCA9IGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiAkYXV0aC5sb2dvdXQoKVxuICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgICRzY29wZS51c2VyID0gbnVsbDtcbiAgICAgIH0pO1xuICB9O1xuXG4gICRzY29wZS5pc0F1dGhlbnRpY2F0ZWQgPSBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gJGF1dGguaXNBdXRoZW50aWNhdGVkKCk7XG4gIH07XG5cbiAgJHNjb3BlLmdldFByb2ZpbGUgPSBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gQWNjb3VudC5nZXQoKVxuICAgICAgLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2UpIHtcbiAgICAgICAgJHNjb3BlLnVzZXIgPSByZXNwb25zZS5kYXRhO1xuICAgICAgICByZXR1cm4gJHNjb3BlLnVzZXI7XG4gICAgICB9KVxuICAgICAgLmNhdGNoKGZ1bmN0aW9uKGVycm9yKSB7XG4gICAgICAgIGlmIChlcnJvcikgJHJvb3RTY29wZS5tZXNzYWdlcy5lcnJvciA9IGVycm9yLmRhdGEuZXJyb3JzO1xuICAgICAgfSk7XG4gIH07XG5cbn1dKVxuXG4uY29udHJvbGxlcignTmF2Q3RybCcsIFsnJHJvb3RTY29wZScsICckc2NvcGUnLCAnJHN0YXRlJywgJ1NvdW5kY2xvdWQnLCBmdW5jdGlvbigkcm9vdFNjb3BlLCAkc2NvcGUsICRzdGF0ZSwgU291bmRjbG91ZCkge1xuXG4gICRzdGF0ZS5nbygndHJlbmRpbmcud2VlaycpO1xuXG4gICRzY29wZS5hY3RpdmVUYWIgPSBmdW5jdGlvbih0YWIpIHtcbiAgICByZXR1cm4gdGFiID09PSAkc3RhdGUuY3VycmVudC5uYW1lO1xuICB9O1xuXG4gICRzY29wZS4kb24oJ2RhdGE6bm90Rm91bmQnLCBmdW5jdGlvbigpIHtcbiAgICAkcm9vdFNjb3BlLm1lc3NhZ2VzLm5vRGF0YUZvdW5kID0gdHJ1ZTtcbiAgfSk7XG5cbiAgJHNjb3BlLiRvbignZGF0YTpmb2xsb3cnLCBmdW5jdGlvbigpIHtcbiAgICAkcm9vdFNjb3BlLm1lc3NhZ2VzLmZvbGxvdyA9IHRydWU7XG4gIH0pO1xuXG4gICRzY29wZS4kb24oJ2RhdGE6ZXJyb3InLCBmdW5jdGlvbihldnQsIGVycm9yKSB7XG4gICAgY29uc29sZS5sb2coZXJyb3IpO1xuICAgICRyb290U2NvcGUubWVzc2FnZXMuZXJyb3IgPSBlcnJvci5kYXRhLmVycm9ycztcbiAgfSk7XG59XSlcblxuLmNvbnRyb2xsZXIoJ1RyZW5kaW5nQ3RybCcsXG4gIFsnJHNjb3BlJywgJyRxJywgJ1NvdW5kY2xvdWQnLCAnbXVzaWNDYWNoZScsICd0aW1lZnJhbWUnLCAnJHN0YXRlJyxcbiAgZnVuY3Rpb24oJHNjb3BlLCAkcSwgU291bmRjbG91ZCwgbXVzaWNDYWNoZSwgdGltZWZyYW1lLCAkc3RhdGUpIHtcblxuICAkc2NvcGUuc2hvd0xvYWRpbmcgPSBmYWxzZTtcblxuICBpZiAobXVzaWNDYWNoZS5jYWNoZWQpIHtcbiAgICAkcS53aGVuKFNvdW5kY2xvdWQuZmlsdGVyQnlUaW1lKG11c2ljQ2FjaGUuZ2V0KCksIHRpbWVmcmFtZS50aW1lKSlcbiAgICAgIC50aGVuKGZ1bmN0aW9uKHNvbmdzKSB7XG4gICAgICAgICRzY29wZS5zaG93TG9hZGluZyA9IGZhbHNlO1xuICAgICAgICAkc2NvcGUuc29uZ3MgPSBzb25ncztcbiAgICAgICAgaWYgKCFzb25ncy5sZW5ndGgpIHtcbiAgICAgICAgICAkc2NvcGUuJGVtaXQoJ2RhdGE6bm90Rm91bmQnKTtcbiAgICAgICAgfSBlbHNlIGlmIChzb25ncy5sZW5ndGggPCAxMCkge1xuICAgICAgICAgICRzY29wZS4kZW1pdCgnZGF0YTpmb2xsb3cnKTtcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICAgIC5jYXRjaChmdW5jdGlvbihlcnJvcikge1xuICAgICAgICAkc2NvcGUuc2hvd0xvYWRpbmcgPSBmYWxzZTtcbiAgICAgICAgaWYgKGVycm9yKSAkc2NvcGUuJGVtaXQoJ2RhdGE6ZXJyb3InLCBlcnJvcik7XG4gICAgICB9KTtcbiAgfSBlbHNlIHtcbiAgICAkc2NvcGUuc2hvd0xvYWRpbmcgPSB0cnVlO1xuICAgICRzY29wZS5nZXRQcm9maWxlKCkudGhlbihmdW5jdGlvbih1c2VyKSB7XG4gICAgICBcbiAgICAgIFNvdW5kY2xvdWQucGFyc2VVc2VyKHVzZXIudWlkKVxuICAgICAgICAudGhlbihmdW5jdGlvbihzb25ncykge1xuICAgICAgICAgICRzY29wZS5zaG93TG9hZGluZyA9IGZhbHNlO1xuICAgICAgICAgIG11c2ljQ2FjaGUuc2V0KHNvbmdzKTtcblxuICAgICAgICAgICRxLndoZW4oU291bmRjbG91ZC5maWx0ZXJCeVRpbWUoc29uZ3MsIHRpbWVmcmFtZS50aW1lKSlcbiAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKGZpbHRlcmVkU29uZ3MpIHtcbiAgICAgICAgICAgICAgJHNjb3BlLnNvbmdzID0gZmlsdGVyZWRTb25ncztcbiAgICAgICAgICAgICAgaWYgKCFmaWx0ZXJlZFNvbmdzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICRzY29wZS4kZW1pdCgnZGF0YTpub3RGb3VuZCcpO1xuICAgICAgICAgICAgICB9IGVsc2UgaWYgKGZpbHRlcmVkU29uZ3MubGVuZ3RoIDwgMTApIHtcbiAgICAgICAgICAgICAgICAkc2NvcGUuJGVtaXQoJ2RhdGE6Zm9sbG93Jyk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24oZXJyb3IpIHtcbiAgICAgICAgICAgICAgaWYgKGVycm9yKSAkc2NvcGUuJGVtaXQoJ2RhdGE6ZXJyb3InLCBlcnJvcik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgIGlmIChlcnIpICRzY29wZS4kZW1pdCgnZGF0YTplcnJvcicsIGVycik7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgLy8gJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHtcbiAgLy8gICAkc2NvcGUuc29uZ3MgPSBudWxsO1xuICAvLyB9KTtcblxuICBcbiAgLy8gJHNjb3BlLnNvbmdzID0gW1xuICAvLyAgIHtcbiAgLy8gICAgIGlkOiAxNjg0Nzk2MzEsXG4gIC8vICAgICBwZXJtYWxpbmtfdXJsOiBcImh0dHA6Ly9zb3VuZGNsb3VkLmNvbS9zYnRya3Qvc2J0cmt0LXRoZS1saWdodC1mZWF0LWRlbmFpLW1vb3JlXCIsXG4gIC8vICAgICB0aXRsZTogXCJTQlRSS1QgLSBUSEUgTElHSFQgZnQgRGVuYWkgTW9vcmVcIixcbiAgLy8gICAgIHVzZXI6IHtcbiAgLy8gICAgICAgcGVybWFsaW5rX3VybDogXCJodHRwOi8vc291bmRjbG91ZC5jb20vc2J0cmt0XCIsXG4gIC8vICAgICAgIHVzZXJuYW1lOiBcIlNCVFJLVFwiXG4gIC8vICAgICB9XG4gIC8vICAgfSxcbiAgLy8gICB7XG4gIC8vICAgICBpZDogMTY4OTkyMzg1LFxuICAvLyAgICAgcGVybWFsaW5rX3VybDogXCJodHRwOi8vc291bmRjbG91ZC5jb20vZm91ci10ZXQvam9obi1iZWx0cmFuLWZhdXgtZm91ci10ZXQtcmVtaXh0ZXh0MDMzXCIsXG4gIC8vICAgICB0aXRsZTogXCJKb2huIEJlbHRyYW4gLSBGYXV4IChGb3VyIFRldCBSZW1peClURVhUMDMzXCIsXG4gIC8vICAgICB1c2VyOiB7XG4gIC8vICAgICAgIHBlcm1hbGlua191cmw6IFwiaHR0cDovL3NvdW5kY2xvdWQuY29tL2ZvdXItdGV0XCIsXG4gIC8vICAgICAgIHVzZXJuYW1lOiBcIkZvdXIgVGV0XCJcbiAgLy8gICAgIH1cbiAgLy8gICB9LFxuICAvLyAgIHtcbiAgLy8gICAgIGlkOiAxNjg0NjAwNDQsXG4gIC8vICAgICBwZXJtYWxpbmtfdXJsOiBcImh0dHA6Ly9zb3VuZGNsb3VkLmNvbS94bHI4ci9raWRrYW5ldmlsLXRob3VzYW5kLXllYXItZm9yZXN0LW9uZS1mb3IteW9zaVwiLFxuICAvLyAgICAgdGl0bGU6IFwia2lka2FuZXZpbCAtIFRob3VzYW5kIFllYXIgRm9yZXN0IChPbmUgZm9yIFlvc2kpXCIsXG4gIC8vICAgICB1c2VyOiB7XG4gIC8vICAgICAgIHBlcm1hbGlua191cmw6IFwiaHR0cDovL3NvdW5kY2xvdWQuY29tL3hscjhyXCIsXG4gIC8vICAgICAgIHVzZXJuYW1lOiBcIlhMUjhSXCJcbiAgLy8gICAgIH1cbiAgLy8gICB9XG4gIC8vIF07XG5cbn1dKTtcbiIsImFuZ3VsYXIubW9kdWxlKCdhcHAuZGlyZWN0aXZlcycsIFtdKVxuXG4uZGlyZWN0aXZlICdtdXNpY1BsYXllcicsIFsnJGh0dHAnLCAnc291bmRjbG91ZFVybCcsICdjbGllbnRJZCcsICgkaHR0cCwgc291bmRjbG91ZFVybCwgY2xpZW50SWQpIC0+XG4gIHJlc3RyaWN0OiAnQSdcbiAgdGVtcGxhdGVVcmw6ICdtdXNpYy1wbGF5ZXIuaHRtbCdcbiAgc2NvcGU6XG4gICAgdXJsOiAnQCdcbiAgICB0aXRsZTogJ0AnXG4gICAgdXNlcm5hbWU6ICdAJ1xuICAgIGFydGlzdFVybDogJ0AnXG4gIGxpbms6IChzY29wZSwgZWxlbSwgYXR0cnMpIC0+XG5cbiAgICBhdWRpbyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQgJ2F1ZGlvJ1xuICAgIGN1cnJlbnRUaW1lID0gMFxuICAgIHNyYyA9IFwiI3tzb3VuZGNsb3VkVXJsfXRyYWNrcy8je2F0dHJzLm11c2ljUGxheWVyfS9zdHJlYW0/Y2xpZW50X2lkPSN7Y2xpZW50SWR9XCJcblxuICAgIHNjb3BlLnBsYXlpbmcgPSBmYWxzZVxuICAgIHNjb3BlLmN1cnJlbnRUaW1lID0gMFxuICAgIHNjb3BlLmR1cmF0aW9uID0gMFxuICAgIHNjb3BlLmxvYWRpbmdTb25nID0gZmFsc2VcblxuICAgIHNjb3BlLnBsYXkgPSAtPlxuICAgICAgc2NvcGUubG9hZGluZ1NvbmcgPSB0cnVlXG4gICAgICBhdWRpby5zcmMgPSBzcmNcbiAgICAgIGF1ZGlvLnBsYXkoKVxuICAgICAgYXVkaW8uYWRkRXZlbnRMaXN0ZW5lciAnY2FucGxheScsIC0+XG4gICAgICAgIHNjb3BlLmxvYWRpbmdTb25nID0gZmFsc2VcbiAgICAgICAgYXVkaW8uY3VycmVudFRpbWUgfHw9IGN1cnJlbnRUaW1lXG4gICAgICAgIHNjb3BlLnBsYXlpbmcgPSB0cnVlXG5cbiAgICBzY29wZS5wYXVzZSA9IC0+XG4gICAgICBhdWRpby5wYXVzZSgpXG4gICAgICBzY29wZS5sb2FkaW5nU29uZyA9IGZhbHNlXG4gICAgICBzY29wZS5wbGF5aW5nID0gZmFsc2VcblxuICAgIHNjb3BlLnNlZWsgPSAoZSkgLT5cbiAgICAgICMgcmV0dXJuIGZhbHNlIHVubGVzcyBhdWRpby5yZWFkeVN0YXRlXG4gICAgICBpZiBvZmZzZXQgPSBlLm9mZnNldFggfHwgZS5sYXllclggLSBlLnRhcmdldC5vZmZzZXRMZWZ0XG4gICAgICAgIHBlcmNlbnQgPSBvZmZzZXQgLyBlLnRhcmdldC5vZmZzZXRXaWR0aFxuICAgICAgICBkdXJhdGlvbiA9IGF1ZGlvLmR1cmF0aW9uXG4gICAgICAgIHNlZWtUbyA9IGR1cmF0aW9uICogcGVyY2VudFxuICAgICAgICBhdWRpby5jdXJyZW50VGltZSA9IHBhcnNlSW50KHNlZWtUbywgMTApXG5cbiAgICBhdWRpby5hZGRFdmVudExpc3RlbmVyICdwYXVzZScsIC0+XG4gICAgICBjdXJyZW50VGltZSA9IGF1ZGlvLmN1cnJlbnRUaW1lXG4gICAgLCBmYWxzZVxuXG4gICAgYXVkaW8uYWRkRXZlbnRMaXN0ZW5lciAndGltZXVwZGF0ZScsIC0+XG4gICAgICBzY29wZS4kYXBwbHkgLT5cbiAgICAgICAgc2NvcGUuY3VycmVudFRpbWUgPSBhdWRpby5jdXJyZW50VGltZVxuICAgICAgICBzY29wZS5kdXJhdGlvbiA9IGF1ZGlvLmR1cmF0aW9uXG4gICAgLCBmYWxzZVxuXG4gICAgYXVkaW8uYWRkRXZlbnRMaXN0ZW5lciAnZW5kZWQnLCAtPlxuICAgICAgY3VycmVudFRpbWUgPSAwXG4gICAgICBzY29wZS4kYXBwbHkgLT5cbiAgICAgICAgc2NvcGUucGxheWluZyA9IGZhbHNlXG4gICAgLCBmYWxzZVxuXVxuIiwiYW5ndWxhci5tb2R1bGUoJ2FwcC5maWx0ZXJzJywgW10pOyIsImFuZ3VsYXIubW9kdWxlKCdhcHAuc2VydmljZXMnLCBbXSlcblxuLmNvbnN0YW50KCdjbGllbnRJZCcsICc4NjMwNjAxMjFhMmZmYjVkMjU4ZTdhNzkzZGEwNTQ2YicpXG4uY29uc3RhbnQoJ3NvdW5kY2xvdWRVcmwnLCAnLy9hcGkuc291bmRjbG91ZC5jb20vJylcblxuLmZhY3RvcnkoJ1NvdW5kY2xvdWQnLCBbJyRodHRwJywgJyRxJywgJ2NsaWVudElkJywgJ3NvdW5kY2xvdWRVcmwnLCBmdW5jdGlvbigkaHR0cCwgJHEsIGNsaWVudElkLCBzb3VuZGNsb3VkVXJsKSB7XG5cbiAgdmFyIHBhcmFtcyA9IHtcbiAgICBjbGllbnRfaWQ6IGNsaWVudElkXG4gIH07XG5cbiAgdmFyIHBhcnNlVXNlciA9IGZ1bmN0aW9uKHVzZXIpIHtcbiAgICByZXR1cm4gZ2V0Rm9sbG93aW5ncyh1c2VyKVxuICAgICAgLnRoZW4oZnVuY3Rpb24oZm9sbG93ZWRVc2VycykgeyByZXR1cm4gcGFyc2VGb2xsb3dpbmdzKGZvbGxvd2VkVXNlcnMpOyB9KVxuICAgICAgLnRoZW4oZnVuY3Rpb24oZm9sbG93aW5nVXNlclRyYWNrcykgeyByZXR1cm4gcGFyc2VUcmFja3MoXy5mbGF0dGVuKGZvbGxvd2luZ1VzZXJUcmFja3MpKTsgfSk7XG4gIH07XG5cbiAgLy8gcmV0dXJucyBhbiBhcnJheSBvZiB1c2VyIG9iamVjdHNcbiAgdmFyIGdldEZvbGxvd2luZ3MgPSBmdW5jdGlvbih1c2VyKSB7XG4gICAgcmV0dXJuICRodHRwLmdldChzb3VuZGNsb3VkVXJsICsgJ3VzZXJzLycgKyB1c2VyICsgJy9mb2xsb3dpbmdzLmpzb24nLCB7XG4gICAgICBwYXJhbXM6IHBhcmFtc1xuICAgIH0pLnRoZW4oZnVuY3Rpb24oZGF0YSkgeyByZXR1cm4gZGF0YS5kYXRhOyB9KTtcbiAgfTtcblxuICB2YXIgcGFyc2VGb2xsb3dpbmdzID0gZnVuY3Rpb24oZm9sbG93aW5nVXNlcikge1xuICAgIHJldHVybiAkcS5hbGwoXy5tYXAoZm9sbG93aW5nVXNlciwgZnVuY3Rpb24oZm9sbG93aW5nKSB7XG4gICAgICByZXR1cm4gZ2V0VHJhY2tzKGZvbGxvd2luZy5pZCk7XG4gICAgfSkpO1xuICB9O1xuXG4gIHZhciBnZXRUcmFja3MgPSBmdW5jdGlvbih1c2VyKSB7XG4gICAgcmV0dXJuICRxLmFsbChbXG4gICAgICAkaHR0cC5nZXQoc291bmRjbG91ZFVybCArICd1c2Vycy8nICsgdXNlciArICcvZmF2b3JpdGVzLmpzb24nLCB7IHBhcmFtczogcGFyYW1zIH0pLFxuICAgICAgJGh0dHAuZ2V0KHNvdW5kY2xvdWRVcmwgKyAndXNlcnMvJyArIHVzZXIgKyAnL3RyYWNrcy5qc29uJywgeyBwYXJhbXM6IHBhcmFtcyB9KVxuICAgIF0pO1xuICB9O1xuXG4gIHZhciBwYXJzZVRyYWNrcyA9IGZ1bmN0aW9uKGZvbGxvd2luZ1VzZXJUcmFja3MpIHtcblxuICAgIC8vIHJldHVybnMgYSBMb2Rhc2ggb2JqZWN0IChhcnJheSkgb2Ygc29uZyBvYmplY3RzXG4gICAgcmV0dXJuIF8oZm9sbG93aW5nVXNlclRyYWNrcylcbiAgICAgIC5tYXAoZnVuY3Rpb24odHJhY2tzKSB7IGlmICh0cmFja3MuZGF0YSkgcmV0dXJuIHRyYWNrcy5kYXRhOyB9KVxuICAgICAgLmZsYXR0ZW4oKVxuICAgICAgLnJlamVjdChmdW5jdGlvbih0cmFjaykgeyByZXR1cm4gIXRyYWNrLnBsYXliYWNrX2NvdW50OyB9KVxuICAgICAgLnVuaXEoJ2lkJyk7XG4gIH07XG5cblxuICB2YXIgZmlsdGVyQnlUaW1lID0gZnVuY3Rpb24odHJhY2tzLCB0aW1lKSB7XG4gICAgdmFyIGRhdGUgPSBuZXcgRGF0ZSgpO1xuXG4gICAgaWYgKHRpbWUgPT09ICdkYXknKSB7XG4gICAgICB0aW1lID0gZGF0ZS5zZXREYXRlKGRhdGUuZ2V0RGF0ZSgpIC0gMSk7XG4gICAgfSBlbHNlIGlmICh0aW1lID09PSAnd2VlaycpIHtcbiAgICAgIHRpbWUgPSBkYXRlLnNldERhdGUoZGF0ZS5nZXREYXRlKCkgLSA3KTtcbiAgICB9IGVsc2UgaWYgKHRpbWUgPT09ICdtb250aCcpIHtcbiAgICAgIHRpbWUgPSBkYXRlLnNldE1vbnRoKGRhdGUuZ2V0TW9udGgoKSAtIDEpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aW1lID0gbnVsbDtcbiAgICB9XG5cbiAgICByZXR1cm4gdHJhY2tzXG4gICAgICAucmVqZWN0KGZ1bmN0aW9uKHRyYWNrKSB7XG4gICAgICAgIGlmICh0aW1lKSByZXR1cm4gRGF0ZS5wYXJzZSh0cmFjay5jcmVhdGVkX2F0KSA8IHRpbWU7XG4gICAgICAgIGVsc2UgcmV0dXJuO1xuICAgICAgfSlcbiAgICAgIC5zb3J0QnkoJ3BsYXliYWNrX2NvdW50JylcbiAgICAgIC5yZXZlcnNlKClcbiAgICAgIC5maXJzdCgxMClcbiAgICAgIC52YWx1ZSgpO1xuICB9O1xuXG4gIHJldHVybiB7XG4gICAgcGFyc2VVc2VyOiBwYXJzZVVzZXIsXG4gICAgZmlsdGVyQnlUaW1lOiBmaWx0ZXJCeVRpbWVcbiAgfTtcbn1dKVxuXG4uZmFjdG9yeSgnQWNjb3VudCcsIFsnJGh0dHAnLCBmdW5jdGlvbigkaHR0cCkge1xuICByZXR1cm4ge1xuICAgIGdldDogZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4gJGh0dHAuZ2V0KCcvYXBpL21lJyk7XG4gICAgfVxuICB9O1xufV0pXG5cbi5mYWN0b3J5KCdtdXNpY0NhY2hlJywgZnVuY3Rpb24oKSB7XG4gIHZhciBtdXNpY0NhY2hlID0gW107XG4gIHJldHVybiB7XG4gICAgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIG11c2ljQ2FjaGU7IH0sXG4gICAgc2V0OiBmdW5jdGlvbihjYWNoZSkge1xuICAgICAgbXVzaWNDYWNoZSA9IGNhY2hlO1xuICAgICAgdGhpcy5jYWNoZWQgPSB0cnVlO1xuICAgIH0sXG4gICAgY2FjaGVkOiBmYWxzZVxuICB9O1xufSk7Il0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9